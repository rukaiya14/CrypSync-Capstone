{% extends "base.html" %}

{% block title %}Watchlist - CrypSync{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-star"></i> My Watchlist</h2>
            <p class="text-muted">Track your favorite cryptocurrencies</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list"></i> Watched Cryptocurrencies
                </div>
                <div class="card-body">
                    <div id="watchlistContent">
                        <p class="text-muted text-center py-5">
                            <i class="fas fa-star fa-3x mb-3"></i><br>
                            Your watchlist is empty. Go to the <a href="/">home page</a> and click the star icon to add
                            cryptocurrencies to your watchlist.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load watchlist from localStorage (same as favorites in crypto-tracker.js)
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    if (favorites.length > 0) {
        fetchWatchlistData();
    }

    async function fetchWatchlistData() {
        try {
            const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${favorites.join(',')}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`);
            const data = await response.json();

            displayWatchlist(data);
        } catch (error) {
            console.error('Failed to fetch watchlist data:', error);
        }
    }

    function displayWatchlist(cryptos) {
        let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Name</th><th>Price</th><th>24h Change</th><th>Market Cap</th><th>Action</th></tr></thead><tbody>';

        cryptos.forEach(crypto => {
            const change24h = crypto.price_change_percentage_24h || 0;
            const changeClass = change24h >= 0 ? 'positive' : 'negative';

            html += `
            <tr>
                <td>
                    <img src="${crypto.image}" width="24" height="24" class="me-2">
                    <strong>${crypto.name}</strong> <span class="text-muted">${crypto.symbol.toUpperCase()}</span>
                </td>
                <td>$${crypto.current_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td><span class="price-change ${changeClass}">${change24h >= 0 ? '▲' : '▼'} ${Math.abs(change24h).toFixed(2)}%</span></td>
                <td>$${(crypto.market_cap / 1e9).toFixed(2)}B</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeFromWatchlist('${crypto.id}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </td>
            </tr>
        `;
        });

        html += '</tbody></table></div>';
        document.getElementById('watchlistContent').innerHTML = html;
    }

    function removeFromWatchlist(cryptoId) {
        const index = favorites.indexOf(cryptoId);
        if (index > -1) {
            favorites.splice(index, 1);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            location.reload();
        }
    }
</script>
{% endblock %}