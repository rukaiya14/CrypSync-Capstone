{% extends "base.html" %}

{% block title %}Portfolio - CrypSync{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-wallet"></i> My Portfolio</h2>
            <p class="text-muted">Track your cryptocurrency holdings</p>
        </div>
    </div>

    <!-- Portfolio Summary -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">Total Portfolio Value</div>
                    <div class="stat-value" id="totalValue">$0.00</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">Total Invested</div>
                    <div class="stat-value" id="totalInvested">$0.00</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">Profit/Loss</div>
                    <div class="stat-value" id="profitLoss">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHoldingModal">
                <i class="fas fa-plus"></i> Add Holding
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-wallet"></i> Your Holdings
                </div>
                <div class="card-body">
                    <div id="holdingsContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Holding Modal -->
<div class="modal fade" id="addHoldingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Cryptocurrency Holding</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHoldingForm">
                    <div class="mb-3">
                        <label for="cryptoSelect" class="form-label">Cryptocurrency</label>
                        <select class="form-control" id="cryptoSelect" required>
                            <option value="">Select cryptocurrency...</option>
                            <option value="bitcoin">Bitcoin (BTC)</option>
                            <option value="ethereum">Ethereum (ETH)</option>
                            <option value="cardano">Cardano (ADA)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="ripple">Ripple (XRP)</option>
                            <option value="polkadot">Polkadot (DOT)</option>
                            <option value="dogecoin">Dogecoin (DOGE)</option>
                            <option value="avalanche-2">Avalanche (AVAX)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="amount" step="0.00000001" required
                            placeholder="e.g., 2">
                    </div>
                    <div class="mb-3">
                        <label for="purchasePrice" class="form-label">Purchase Price (USD)</label>
                        <input type="number" class="form-control" id="purchasePrice" step="0.01" required
                            placeholder="e.g., 45000">
                    </div>
                    <div id="modalError" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addHolding()">Add Holding</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPrices = {};

    // Load portfolio
    async function loadPortfolio() {
        try {
            const response = await fetch('/api/portfolio');
            const data = await response.json();

            if (data.success) {
                displayPortfolio(data);
            } else {
                showEmptyPortfolio();
            }
        } catch (error) {
            console.error('Failed to load portfolio:', error);
            showEmptyPortfolio();
        }
    }

    // Display portfolio
    function displayPortfolio(data) {
        const portfolio = data.portfolio || {};
        const portfolioValue = data.portfolio_value || {};

        // Update summary
        if (portfolioValue.total_value !== undefined) {
            document.getElementById('totalValue').textContent = '$' + portfolioValue.total_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            let totalInvested = 0;
            portfolioValue.holdings.forEach(h => totalInvested += h.total_invested);
            document.getElementById('totalInvested').textContent = '$' + totalInvested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const profitLoss = portfolioValue.total_value - totalInvested;
            const profitLossElement = document.getElementById('profitLoss');
            profitLossElement.textContent = '$' + profitLoss.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            profitLossElement.className = `stat-value ${profitLoss >= 0 ? 'text-success' : 'text-danger'}`;
        }

        // Display holdings
        const container = document.getElementById('holdingsContainer');

        if (Object.keys(portfolio).length === 0) {
            showEmptyPortfolio();
            return;
        }

        let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Cryptocurrency</th>
                        <th>Amount</th>
                        <th>Avg Price</th>
                        <th>Current Price</th>
                        <th>Current Value</th>
                        <th>Profit/Loss</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (portfolioValue.holdings) {
            portfolioValue.holdings.forEach(holding => {
                const profitLossClass = holding.profit_loss >= 0 ? 'positive' : 'negative';

                html += `
                <tr>
                    <td><strong>${holding.crypto_id.toUpperCase()}</strong></td>
                    <td>${holding.amount.toFixed(8)}</td>
                    <td>$${holding.avg_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>$${holding.current_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>$${holding.current_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>
                        <span class="price-change ${profitLossClass}">
                            ${holding.profit_loss >= 0 ? '▲' : '▼'} $${Math.abs(holding.profit_loss).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            (${holding.profit_loss_pct.toFixed(2)}%)
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeHolding('${holding.crypto_id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            });
        }

        html += `
                </tbody>
            </table>
        </div>
        `;

        container.innerHTML = html;
    }

    // Show empty portfolio
    function showEmptyPortfolio() {
        const container = document.getElementById('holdingsContainer');
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                <p class="text-muted">You don't have any cryptocurrency holdings yet.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHoldingModal">
                    <i class="fas fa-plus"></i> Add Your First Holding
                </button>
            </div>
        `;

        // Reset summary
        document.getElementById('totalValue').textContent = '$0.00';
        document.getElementById('totalInvested').textContent = '$0.00';
        document.getElementById('profitLoss').textContent = '$0.00';
    }

    // Add holding
    async function addHolding() {
        const cryptoId = document.getElementById('cryptoSelect').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
        const errorDiv = document.getElementById('modalError');

        // Validation
        if (!cryptoId || !amount || !purchasePrice) {
            errorDiv.textContent = 'Please fill all fields';
            errorDiv.classList.remove('d-none');
            return;
        }

        if (amount <= 0) {
            errorDiv.textContent = 'Amount must be greater than 0';
            errorDiv.classList.remove('d-none');
            return;
        }

        if (purchasePrice <= 0) {
            errorDiv.textContent = 'Purchase price must be greater than 0';
            errorDiv.classList.remove('d-none');
            return;
        }

        try {
            const response = await fetch('/api/portfolio/buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crypto_id: cryptoId,
                    amount: amount,
                    price_usd: purchasePrice
                })
            });

            const data = await response.json();

            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addHoldingModal')).hide();

                // Reset form
                document.getElementById('addHoldingForm').reset();
                errorDiv.classList.add('d-none');

                // Reload portfolio
                loadPortfolio();

                // Show success message
                alert('Holding added successfully!');
            } else {
                errorDiv.textContent = data.message || 'Failed to add holding';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('d-none');
        }
    }

    // Remove holding
    async function removeHolding(cryptoId) {
        if (!confirm(`Are you sure you want to remove ${cryptoId.toUpperCase()} from your portfolio?`)) {
            return;
        }

        try {
            // Get current holding amount
            const response = await fetch('/api/portfolio');
            const data = await response.json();

            if (data.success && data.portfolio[cryptoId]) {
                const amount = data.portfolio[cryptoId].amount;

                // Sell all
                const sellResponse = await fetch('/api/portfolio/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        crypto_id: cryptoId,
                        amount: amount
                    })
                });

                const sellData = await sellResponse.json();

                if (sellData.success) {
                    loadPortfolio();
                    alert('Holding removed successfully!');
                } else {
                    alert('Error: ' + sellData.message);
                }
            }
        } catch (error) {
            alert('Failed to remove holding');
        }
    }

    // Initial load
    loadPortfolio();

    // Auto-refresh every 60 seconds
    setInterval(loadPortfolio, 60000);
</script>
{% endblock %}