{% extends "base.html" %}

{% block title %}{{ crypto_id|title }} - CrypSync{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <a href="/" class="btn btn-outline-primary mb-3">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            <h2 id="cryptoName">Loading...</h2>
            <p class="text-muted" id="cryptoSymbol"></p>
        </div>
    </div>

    <!-- Price Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">Current Price</div>
                    <div class="stat-value" id="currentPrice">$0.00</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">24h Change</div>
                    <div class="stat-value" id="change24h">0%</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">Market Cap</div>
                    <div class="stat-value" id="marketCap">$0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-label">24h Volume</div>
                    <div class="stat-value" id="volume24h">$0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Price Chart (7 Days)
                </div>
                <div class="card-body">
                    <canvas id="priceChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> About
                </div>
                <div class="card-body" id="cryptoDescription">
                    <p class="text-muted">Loading description...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
    const cryptoId = '{{ crypto_id }}';

    async function fetchCryptoDetail() {
        try {
            const response = await fetch(`https://api.coingecko.com/api/v3/coins/${cryptoId}?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=true`);
            const data = await response.json();

            displayCryptoDetail(data);
        } catch (error) {
            console.error('Failed to fetch crypto detail:', error);
            document.getElementById('cryptoName').textContent = 'Error loading data';
        }
    }

    function displayCryptoDetail(data) {
        document.getElementById('cryptoName').innerHTML = `<img src="${data.image.small}" width="32" height="32" class="me-2">${data.name}`;
        document.getElementById('cryptoSymbol').textContent = data.symbol.toUpperCase();

        const price = data.market_data.current_price.usd;
        const change24h = data.market_data.price_change_percentage_24h;
        const marketCap = data.market_data.market_cap.usd;
        const volume = data.market_data.total_volume.usd;

        document.getElementById('currentPrice').textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        const changeElement = document.getElementById('change24h');
        changeElement.textContent = `${change24h >= 0 ? '▲' : '▼'} ${Math.abs(change24h).toFixed(2)}%`;
        changeElement.className = `stat-value ${change24h >= 0 ? 'text-success' : 'text-danger'}`;

        document.getElementById('marketCap').textContent = `$${(marketCap / 1e9).toFixed(2)}B`;
        document.getElementById('volume24h').textContent = `$${(volume / 1e9).toFixed(2)}B`;

        if (data.description && data.description.en) {
            const description = data.description.en.replace(/<[^>]*>/g, '').substring(0, 500) + '...';
            document.getElementById('cryptoDescription').innerHTML = `<p>${description}</p>`;
        }

        // Draw chart
        if (data.market_data.sparkline_7d && data.market_data.sparkline_7d.price) {
            drawChart(data.market_data.sparkline_7d.price);
        }
    }

    function drawChart(prices) {
        const ctx = document.getElementById('priceChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: prices.map((_, i) => ''),
                datasets: [{
                    label: 'Price (USD)',
                    data: prices,
                    borderColor: '#ff9500',
                    backgroundColor: 'rgba(255, 149, 0, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function (value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    fetchCryptoDetail();
</script>
{% endblock %}